<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<title>致不甘平凡的你</title>
		<link rel="stylesheet" href="css/lab.css" />
		<link rel="stylesheet" href="css/iconfont.css"/>
		<link rel="stylesheet" href="css/basic.css"/>
		<script src="js/jquery-3.3.1.min.js"></script>
		<script src="js/turn.js"></script>
		<script src="js/common.js"></script>
	</head>

	<body style="overflow: hidden;">
		<header id="read_header">
		  <input id="btn_back" type="image" src="images/arraw.png" width="30" style="margin-left: -0.35rem;" />
		</header>
		
		<section id="main_text">

		</section>
		<div id="btn_area">
			<button id="prev_section" disabled class="btn-common" style="visibility: hidden;">上一页</button>
			<button id="back_start" class="btn-common">返回目录</button>
			<button id="next_section" class="btn-common">下一页</button>
		</div>

		<!--底部用户信息-->
		<footer id="user_info">
		  <button id="btn_menu"> 
			<i class="iconfont icon-mulu"></i>
		  	<div class="menu-txt">目录</div>
		  </button>
		  <div id="infos"> 
			  <div style="font-size: 12px;">正在阅读：致不甘平凡的你</div>
<!--			 <img id="user_head" src="images/head.png"/>
			 <div id="info_area">
				 <div>冷饮部：员工姓名</div>
				 <div>正在阅读：<span id="t">00:00</span></div>
			 </div>-->
		  </div>
		</footer>

		
		<!--弹出目录-->
		<div id="slide_list">
			<header>至不平凡的你</header>
			<ul id="read_mlist">
			  <li><a href="reading_img.html" class="mlist-active">卷首语</a></li>
			  <li><a id="p6" data-p="6">素养元素-积极进取</a></li>
			  <li><a id="p13" data-p="13">素养元素-敏思笃行</a></li>
			  <li><a id="p23" data-p="23">素养元素-诚信正直</a></li>
			  <li><a id="p32" data-p="32">素养元素-谦逊务实</a></li>
			  <li><a id="p42" data-p="42">素养元素-热情友善</a></li>
			  <li><a id="p50" data-p="50">素养元素-有礼有节</a></li>
			  <li><a id="p57" data-p="57">素养元素-思恩敬畏</a></li>
			  <li><a id="p68" data-p="68">素养元素-行善利他</a></li>
			  <li><a id="p76" data-p="76">附录一-开卷有益</a></li>
			</ul>
		</div>
		
		<div id="mask"></div>

		<script>		
			
			$.ajax("https://customer.imotstudio.net/ylLibary/api/Front/BookClick?BookID=8",{
				method:'put'
			}).done(function(res){
				console.log(res);
			});
			
			
			var pageNum=GetQueryString('p');
			console.log(pageNum);
			
			$("#btn_menu").on('touchend',function(e){
					e.preventDefault();
					$("#mask").toggle();
					$("#btn_menu").toggleClass('active');
					$("#slide_list").toggleClass("show");
					$("body").toggleClass("cancel-scroll");
			});
				
			$("#btn_back,#back_start").on('touchend',function(){
					location.replace("startread.html");
			});
				
			$("#next_section").on('touchend',function(){
					$("#main_text").turn("next");
			})
			
			$("#prev_section").on('touchend',function(){
					$("#main_text").turn("previous");
			})
				
			var t=setInterval("timer('t')",1000);
				
			$("#mask").on('touchmove',function(e){
					e.preventDefault();
					e.stopPropagation();
			});
				
			var wheight=$(window).height();
			h=wheight-wheight*0.12;
			$("body").css('height',h);
			
			
			//判断屏幕高度，并载入所有图书页
			var pages=155;
			let wHeight=window.innerHeight;		
			let src='books/zbgpfdn/mobile/Page';
			let pics=[]
			if(wHeight>700){
				src='books/zbgpfdn/mobile/800/Page';
				pages=124;
			}
			for(let i=1;i<=pages;i++){
			   let picSrc=src+i+'.png';
			   pics.push(picSrc);
			}
			
			$("body").append('<div id="loading">正在加载图书...</div>');
			
			function loadImgs(srcArr,i){
				$("#mask").css({
					'display':'block',
					'z-index':'28000'
				});

				if(i<srcArr.length){
					var img=new Image();
					img.src=pics[i];
					img.onload=function(){
						//$("#loading > span").text(i+'/'+pages);
						$("#main_text").append('<div class="book-img-page" style="background-image: url('+img.src+')"></div>');
						loadImgs(srcArr,i+1);
					}
				}else{
					$("#mask").css({
						'display':'none',
						'z-index':'10000'
					});
					$("#loading").remove();
					loadApp();
					if(pageNum!=""){
						$("#main_text").turn("page", pageNum);
						$('#read_mlist a').removeClass('mlist-active');
						$('#p'+pageNum).addClass('mlist-active');
					}
					
					$("#read_mlist a").on('touchend',function(e){
						e.preventDefault();
						e.stopPropagation();
						var selPage=$(this).data('p');
						$("#main_text").turn("page", selPage);
						$("#btn_menu").trigger('touchend');
						$('#read_mlist a').removeClass('mlist-active');
						$('#p'+selPage).addClass('mlist-active');
					})
					
				}
			}
			
			loadImgs(pics,0);

			function loadApp() {
				// Create the flipbook
				var w=$("#main_text").width();
			    var th=$("#main_text").height();
				console.log(w+','+th);
			
				$('#main_text').turn({
						// Width
						width:w,
						// Height
						height:th,
						// Elevation
						elevation: 50,
						// Enable gradients
						gradients: true,
						// Auto center this flipbook
						autoCenter: false,
						//
						display: 'single',
						when: {
							first: function(event, page, pageObject) {
								// Implementation
								$("#prev_section").prop('disabled',true).css('visibility','hidden');
							},
							last:function(event, page, pageObject) {
								// Implementation
								$("#next_section").prop('disabled',true).css('visibility','hidden');
							},

							turning:function(event, page, pageObject){
								if(page>1){
									$("#prev_section").css('visibility','visible').prop('disabled',false);
								}
								//总页数
								var total=$("#main_text").turn("pages");
								if(page<total){
									$("#next_section").prop('disabled',false).css('visibility','visible');
								}
								localStorage.setItem('p',page);
							}
						}

				});
			}
			
			
			
		
		</script>
		
    </body>
</html>
